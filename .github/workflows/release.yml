name: Build Release Artifacts

on:
  push:
    tags:
      - 'v*'   # trigger on version tags

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - name: glibc
            arch: arm64
          - name: box64
            arch: arm64
          - name: uml
            arch: x86_64
            kernel: 5.15.200
          - name: uml
            arch: x86_64
            kernel: 6.12.73
          - name: uml
            arch: arm64
            kernel: 5.15.200
          - name: uml
            arch: arm64
            kernel: 6.12.73

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up QEMU (for cross-compilation)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/arm64,linux/amd64

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget curl git bc bison flex libssl-dev libncurses5-dev cmake

      - name: Build artifact
        run: |
          mkdir -p out
          if [ "${MATRIX_TARGET_NAME}" = "glibc" ]; then
            wget http://ftp.gnu.org/gnu/libc/glibc-2.42.tar.gz
            tar xf glibc-2.42.tar.gz
            mkdir glibc-build && cd glibc-build
            ../glibc-2.42/configure --prefix=/usr --host=${MATRIX_TARGET_ARCH}-linux-gnu
            make -j$(nproc)
            make DESTDIR=$PWD/out install
          elif [ "${MATRIX_TARGET_NAME}" = "box64" ]; then
            git clone https://github.com/ptitSeb/box64.git
            cd box64
            mkdir build && cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_SYSTEM_PROCESSOR=${MATRIX_TARGET_ARCH}
            make -j$(nproc)
            cp box64 ../../out/
          elif [ "${MATRIX_TARGET_NAME}" = "uml" ]; then
            KERNEL_FULL=${MATRIX_TARGET_KERNEL}
            KERNEL_MAJOR=$(echo $KERNEL_FULL | cut -d. -f1)
            URL="https://cdn.kernel.org/pub/linux/kernel/v${KERNEL_MAJOR}.x/linux-${KERNEL_FULL}.tar.xz"
            wget $URL
            tar xf linux-${KERNEL_FULL}.tar.xz
            cd linux-${KERNEL_FULL}
            make ARCH=${MATRIX_TARGET_ARCH} defconfig
            make -j$(nproc) ARCH=${MATRIX_TARGET_ARCH} bzImage
            cp arch/${MATRIX_TARGET_ARCH}/boot/bzImage ../../out/bzImage-${MATRIX_TARGET_ARCH}-kernel${KERNEL_FULL}
          fi
        env:
          MATRIX_TARGET_NAME: ${{ matrix.target.name }}
          MATRIX_TARGET_ARCH: ${{ matrix.target.arch }}
          MATRIX_TARGET_KERNEL: ${{ matrix.target.kernel }}

      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        with:
          files: out/*
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
